<% content_for :title, "Message from #{- @message.client.user_id}" %>

<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fa-solid fa-user"></i>
          Conversation with <%= @message.client.user_id %>
        </h5>
        <span class="badge rounded-pill" style="background-color: <%= urgency_color(@message) %>;">
          <%= urgency_level(@message) %> Urgency
        </span>
      </div>
      <div class="card-body">
        <div class="d-flex flex-column gap-3">
          <!-- Customer Message -->
          <div class="d-flex justify-content-start">
            <div class="chat-bubble">
              <p class="fw-bold mb-1">From: <%= @message.client.user_id %></p>
              <p class="mb-0"><%= @message.message_body %></p>
              <small class="text-muted d-block text-end mt-2"><%= @message.sent_at.strftime("%b %d, %Y at %I:%M %p") %></small>
            </div>
          </div>

          <!-- Agent Responses (if any) -->
          <div id="conversation-thread" data-message-id="<%= @message.id %>">
            <% @message.replies.order(created_at: :asc).each do |reply| %>
              <div class="d-flex justify-content-end" data-reply-id="<%= reply.id %>">
                <div class="chat-bubble agent">
                  <p class="mb-0"><%= reply.body %></p>
                  <small class="text-white-50 d-block text-end mt-2"><%= time_ago_in_words(reply.created_at) %> ago</small>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fa-solid fa-reply"></i> Respond to Message</h5>
      </div>
      <div class="card-body">
        <%= form_with(model: [@message, @message.replies.build], local: true) do |form| %>
          <div class="mb-3">
            <%= form.label :body, "Write a custom response", class: "form-label" %>
            <%= form.text_area :body, class: "form-control", rows: 4, placeholder: "Type your reply..." %>
          </div>

          <div class="d-grid">
            <%= form.submit "Send Reply", class: "btn btn-primary btn-lg" %>
          </div>
        <% end %>

        <div class="text-center my-3">
          <span class="text-muted">OR</span>
        </div>

        <%= form_with(model: [@message, @message.replies.build], local: true) do |form| %>
          <div class="mb-3">
            <%= form.label :canned_message_id, "Select a canned response", class: "form-label" %>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-bolt"></i></span>
              <%= collection_select(:reply, :body, CannedMessage.all, :body, :title, { prompt: "Choose a quick response..." }, { class: "form-select" }) %>
            </div>
          </div>
          <div class="d-grid">
            <%= form.submit "Send Canned Response", class: "btn btn-secondary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fa-solid fa-user-circle"></i> Customer Details</h5>
      </div>
      <div class="card-body">
        <p><strong>Customer ID:</strong> <%= @customer.user_id %></p>
        <p><strong>Name:</strong> <%= @customer.name %></p>
        <p><strong>Email:</strong> <%= @customer.email %></p>
        <p><strong>Phone:</strong> <%= @customer.phone %></p>
        <p><strong>Type:</strong> <%= @customer.customer_type.to_s.humanize %></p>
        <p><strong>Notes:</strong> <%= @customer.notes %></p>
      </div>
    </div>
  </div>
</div>
